generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                    String  @id
  type                  String
  name                  String?
  cloud_organization_id String?

  users        User[]
  environments Environment[]
}

model User {
  id         String  @id
  account_id String
  email      String
  first_name String?
  last_name  String?
  created_at Int
  updated_at Int?
  deleted_at Int?

  account Account @relation(fields: [account_id], references: [id])
}

model Environment {
  id                      String  @id
  account_id              String
  type                    String
  enable_new_integrations Boolean
  created_at              Int
  updated_at              Int?
  deleted_at              Int?

  api_keys        ApiKey[]
  integrations    Integration[]
  linked_accounts LinkedAccount[]
  link_tokens     LinkToken[]
  webhooks        Webhook[]
  activities      Activity[]

  account Account @relation(fields: [account_id], references: [id])
}

model ApiKey {
  id             String  @id
  environment_id String
  key            String  @unique
  key_iv         String?
  key_tag        String?
  name           String?
  created_at     Int
  updated_at     Int?
  deleted_at     Int?

  environment Environment @relation(fields: [environment_id], references: [id])
}

model Integration {
  provider               String
  environment_id         String
  is_enabled             Boolean
  use_client_credentials Boolean
  oauth_client_id        String?
  oauth_client_secret    String?
  oauth_scopes           String?
  rank                   Int?
  created_at             Int
  updated_at             Int?
  deleted_at             Int?

  environment Environment @relation(fields: [environment_id], references: [id])

  @@unique([provider, environment_id])
}

model LinkedAccount {
  id                   String  @id
  environment_id       String
  integration_provider String
  credentials          String
  credentials_iv       String?
  credentials_tag      String?
  configuration        Json
  metadata             Json?
  consent_given        Boolean @default(false)
  consent_ip           String?
  consent_date         Int?
  created_at           Int
  updated_at           Int?
  deleted_at           Int?

  activities Activity[]

  environment Environment @relation(fields: [environment_id], references: [id])
}

model LinkToken {
  id                     String  @id
  environment_id         String
  integration_provider   String?
  linked_account_id      String?
  expires_at             Int
  language               String?
  redirect_url           String?
  metadata               Json?
  can_choose_integration Boolean
  consent_given          Boolean @default(false)
  consent_ip             String?
  consent_date           Int?
  configuration          Json?
  websocket_client_id    String?
  link_method            String?
  code_verifier          String?
  request_token_secret   String?
  created_at             Int
  updated_at             Int?

  activities Activity[]

  environment Environment @relation(fields: [environment_id], references: [id])
}

model Webhook {
  id             String   @id
  environment_id String
  url            String
  events         String[]
  is_enabled     Boolean
  secret         String
  secret_iv      String?
  secret_tag     String?
  created_at     Int
  updated_at     Int?
  deleted_at     Int?

  environment Environment @relation(fields: [environment_id], references: [id])
}

model Activity {
  id                   String  @id
  environment_id       String
  integration_provider String?
  linked_account_id    String?
  link_token_id        String?
  level                String
  action               String
  timestamp            Int

  activity_logs ActivityLog[]

  environment    Environment    @relation(fields: [environment_id], references: [id])
  linked_account LinkedAccount? @relation(fields: [linked_account_id], references: [id])
  link_token     LinkToken?     @relation(fields: [link_token_id], references: [id])
}

model ActivityLog {
  id          String @id
  activity_id String
  level       String
  message     String
  payload     Json?
  timestamp   Int

  activity Activity @relation(fields: [activity_id], references: [id])
}
